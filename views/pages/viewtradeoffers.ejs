<link rel="stylesheet" type="text/css" href="/styles/viewtradeoffers.css">
<% include base %>
<% include ../partials/sendmessagemodal %>

<% if(user != undefined){%>
    <div class="container mt-3">
            <div class="row">
              <div class="col-sm-3"></div>
              <div class="col-sm-6">
                    <div class="carousel-div">
                            <div id="carouselExampleIndicators" class="carousel slide shadow border-secondary" data-interval="false">
                                <div class="carousel-inner p-5 m-2">
                                </div>
                                <a class="carousel-control-prev" href="#carouselExampleIndicators" role="button" data-slide="prev">
                                    <span class="carousel-control-prev-icon bg-secondary mr-5" aria-hidden="true"></span>
                                    <span class="sr-only">Previous</span>
                                </a>
                                <a class="carousel-control-next" href="#carouselExampleIndicators" role="button" data-slide="next">
                                    <span class="carousel-control-next-icon bg-secondary ml-5" aria-hidden="true"></span>
                                    <span class="sr-only">Next</span>
                                </a>
                                <br>
                                <br>
                                <ol class="carousel-indicators">
                                    <li data-target="#carouselExampleIndicators" data-slide-to="0" class="bg-secondary active mt-5"></li>
                                </ol>
                            </div>
                        </div>
              </div>
              <div class="col-sm-3"></div>
            </div>
          </div>
    
<% } %> 
<script>
    var AllTradeOffers = [];
    var AllItems = [];
    <% tradeOffers.forEach((offer) => { %>
        var t = {
            "id": '<%= offer.id %>',
            "message": '<%= offer.message %>',
            "acceptedOffer": '<%= offer.acceptedOffer %>',
            "postedBy": '<%= offer.postedBy %>',
            "moneyOffered": '<%= offer.moneyOffered %>',
            "cashOnly": '<%= offer.cashOnly %>',
            "datePosted": '<%= offer.datePosted %>'
        };
        AllTradeOffers.push(t);
    <% }); %>

    <% items.forEach((item) => { %>
        var i = {
            "id": '<%= item.item_id %>',
            "name": '<%= item.item_name %>',
            "partOfOffer": '<%= item.part_of_offer %>',
            "location": '<%= item.item_location %>',
            "cost": '<%= item.est_cost %>',
            "description:": '<%= item.description %>',
            "category:": '<%= item.category %>',
            "datePosted": '<%= item.date_posted %>',
            "img": '<%= item.main_img %>',
            "sold": '<%= item.sold_status %>'
        };
        AllItems.push(i);
    <% }); %>

    function displayOffers(offers, items){
        var carousel = document.getElementsByClassName('carousel-inner')[0];
        var firstOffer = offers[0];
        //Get items in the offer
        var itemsInThisTrade = [];
        items.forEach((item) => {
            if(item.partOfOffer == firstOffer.id){
                itemsInThisTrade.push(item);
            }
        });
        //Get item images
        var itemImages = '';
        itemsInThisTrade.forEach((item) => {
            itemImages += '<img class="d-block w-100" src="https://test123-njs.s3.eu-west-2.amazonaws.com/'+item.img+'" alt="Item Image" onclick="window.location=\'/makeoffer/'+item.id+'\'">';
        });
        var firstOfferDiv = document.createElement('div');
        firstOfferDiv.classList.add('carousel-item');
        firstOfferDiv.classList.add('active');
        firstOfferDiv.innerHTML = `
        <div class="d-block w-100">
                <h2 class="w-100 text-center font-weight-light"> Offer from <button class="btn btn-outline-primary mb-2 popupmodal">${firstOffer.postedBy}</button> </h2>
                ` + itemImages + `
                <h5 class="pt-2">£${firstOffer.moneyOffered}</h5>
                <h5 class="font-weight-light">${String(firstOffer.datePosted).substring(0, 16)}</h5>
                <br>
                <p class="text-muted">${firstOffer.message}</p>
                <button class="btn btn-outline-success w-50 float-left accept-offer" id="` + firstOffer.id + `">Accept</button>
                <button class="btn btn-outline-danger w-50 float-right decline-offer" id="` + firstOffer.id + `">Decline</button>
        </div>`;
        carousel.appendChild(firstOfferDiv);
        //Add the rest of the offers
        offers = offers.slice(1, offers.length);
        offers.forEach((offer) => {
            //Get items in the offer
            var itemsInThisTrade = [];
            items.forEach((item) => {
                if(item.partOfOffer == offer.id){
                    itemsInThisTrade.push(item);
                }
            });
            var itemImages = '';
            itemsInThisTrade.forEach((item) => {
                itemImages += '<img class="d-block w-100" src="https://test123-njs.s3.eu-west-2.amazonaws.com/'+item.img+'" alt="Item Image" onclick="window.location=\'/makeoffer/'+item.id+'\'">';
            });
            var offerDiv = document.createElement('div');
            offerDiv.classList.add('carousel-item');
            offerDiv.innerHTML = `
                <div class="d-block w-100">
                        <h2 class="w-100 text-center font-weight-light"> Offer from <button class="btn btn-outline-primary mb-2 popupmodal">${offer.postedBy}</button> </h2>
                        `+itemImages+`
                        <h5 class="pt-2">£${offer.moneyOffered}</h5>
                        <h5 class="font-weight-light">${String(offer.datePosted).substring(0, 16)}</h5>
                        <br>
                        <p class="text-muted">${offer.message}</p>
                        <button class="btn btn-outline-success w-50 float-left accept-offer" id="` + offer.id + `">Accept</button>
                        <button class="btn btn-outline-danger w-50 float-right decline-offer" id="` + offer.id + `">Decline</button>
                </div>`;
            carousel.appendChild(offerDiv);
        });
        //Adjust carousel indicators
        var indicators = document.getElementsByClassName('carousel-indicators')[0];
        var indicatorsHTML = '';
        for(var i = 0; i < offers.length; i++){
            indicatorsHTML += '<li data-target="#carouselExampleIndicators" data-slide-to="' + i+1 +'" class="bg-secondary mt-5"></li>'
        }
        indicators.innerHTML += indicatorsHTML; 
    }

    displayOffers(AllTradeOffers, AllItems);

    $(function () {
        $('[data-toggle="popover"]').popover()
    });

    <% if(user){ %>
        var elements = document.getElementsByClassName("popupmodal");
        for (var i = 0, len = elements.length; i < len; i++) {
            elements[i].addEventListener("click", function() {
                $('#recipient').attr('value', this.innerHTML);
                $('#sendmessagemodal').modal('show');
            }, false);
        }
    <% } %>

    var acceptOffer = document.getElementsByClassName('accept-offer');
    var declineOffer = document.getElementsByClassName('decline-offer');

    for(var i = 0; i < acceptOffer.length; i++){
        acceptOffer[i].addEventListener('click', (e) => {
            var decision = confirm('Are you sure you want to accept this offer?');
            if(decision){
                var offerID = e.target.id;
                $.post('/acceptoffer/', {
                    id: offerID
                });
            }
        });
        declineOffer[i].addEventListener('click', (e) => {
            var decision = confirm('Are you sure you want to decline this offer?');
            if(decision){
                var offerID = e.target.id;
                $.post('/declineoffer/', {
                    id: offerID
                });
            }
        });
    }
</script>
