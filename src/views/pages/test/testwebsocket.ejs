<% include ../base %>
<!doctype html>
<html>
  <head>
    <title>AnyTimeTrade</title>
    <style>
      * { margin: 0; padding: 0; box-sizing: border-box; }
      body { font: 13px Helvetica, Arial; }
      form { background: #000; padding: 3px; position: fixed; bottom: 0; width: 100%; }
      form input { border: 0; padding: 10px; width: 90%; margin-right: .5%; }
      form button { width: 9%; background: rgb(130, 224, 255); border: none; padding: 10px; }
      #messages { list-style-type: none; margin: 0; padding: 0; }
      #messages li { padding: 5px 10px; }
      #messages li:nth-child(odd) { background: #eee; }
    </style>
  </head>
  <body>
    <ul id="messages" style="padding-left:10px;"></ul>
    <form action="">
      <input id="m" autocomplete="off" /><button>Send</button>
    </form>
    <script>
      <% if(user){ %>
        console.log("user is true");
        console.log('<%= previousMessages.length %>');
        <% for(var i = 0; i < previousMessages.length; i++){ %>
            displayMessage('<%= previousMessages[i].sender %>', '<%= previousMessages[i].message %>');
        <% } %>
      <% } %>
        // $(function () {
          $('form').submit(function(e){   
            e.preventDefault(); // prevents page reloading
            var message = $('#m').val();
            var location = window.location.href.split('/');
            var receiver = location[location.length - 1];
            var sender = location[location.length - 2];
            socket.emit('send message', {'receiver':receiver, 'sender':sender, 'message' :message});
            storeMessage(message, sender, receiver )
            var chatmsg = document.createElement('p');
            chatmsg.innerHTML = 'you: '+message;
            var messages = document.getElementById('messages').appendChild(chatmsg);
            $('#m').val(''); //reset textbox
            return false;
        });

        socket.on('chat message', (msg) => {
            var chatmsg = document.createElement('p');
            chatmsg.innerHTML = msg.sender+': '+msg.message;
            var messages = document.getElementById('messages').appendChild(chatmsg);
            
        });

        function storeMessage(message, sender, receiver){
          $.post('/storemessage', {message, sender, receiver}, (result) => {
            console.log(result);
          });
        };

        function displayMessage(sender, content){
          console.log('adding');
          var chatmsg = document.createElement('p');
          chatmsg.innerHTML = sender + ': ' + content;
          var messages = document.getElementById('messages').appendChild(chatmsg);
        }

    </script>
  </body>
</html>